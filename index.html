<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BROKEN_FIELD</title>
  <script src="./gif.js" type="module"></script>
  <script src="./gif.worker.js" type="module"></script>
  <script src="./index.js" type="module"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="manifest" href="site.webmanifest">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
</head>

<body>
  <f-col class="gap-1">
    <h1>
      BROKEN FIELD
    </h1>
    <main class="gap-1">
      <f-col class="gap-1">
        <textarea id="input" placeholder="Enter an equation!">sx * sy</textarea>
        <ui-element>
          <button id="restart-btn">Restart</button>
          <button id="randomize-btn">Randomize</button>
          <button id="mutate-btn">Mutate</button>
          <button id="simplify-btn">Simplify</button>
        </ui-element>
        <ui-element>
          <button id="share-btn">Copy Sharable Link to Clipboard</button>
          <div id="share-confirm"></div>
        </ui-element>
        <ui-element>
          <label>Time Controls:</label>
          <input type="number" id="time-start" placeholder="start t" , value="0" , class="small-text-input">
          -
          <input type="number" id="time-end" placeholder="end t" , value="" , class="small-text-input">
          </select>
        </ui-element>
        <ui-element>
          <label for="time-scale">Time Scale:</label>
          <input type="range" id="time-scale" value="0.0" min="-1.0" max="1.0" step="any">
          <div id="time-scale-display">1.0x</div>
        </ui-element>
        <ui-element>
          <label for="color">Color</label>
          <input type="color" id="color" value="#00FF00">
        </ui-element>
        <ui-element>
          <label for="wrapping-value">Wrap Value:</label>
          <input type="number" id="wrapping-value" value="256" class="small-text-input">
        </ui-element>
        <ui-element>
          <label>Canvas Size: </label>
          <input type="number" id="canvas-size-x" value="1024" placeholder="x" class="small-text-input" min="1">
          x
          <input type="number" id="canvas-size-y" value="1024" placeholder="y" class="small-text-input" min="1">
        </ui-element>
        <details>
          <summary>Randomization History</summary>
          <ul id="equation-history"></ul>
        </details>
        <details>
          <summary>Advanced Settings</summary>
          <h3>Randomize/Mutate Generation Options</h3>
          <ul>
            <li>
              <ui-element>
                <label for="randomize-enable-t">Generate <code>t&nbsp;</code></label>
                <input type="checkbox" id="randomize-enable-t" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-sx">Generate <code>sx</code></label>
                <input type="checkbox" id="randomize-enable-sx" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-sy">Generate <code>sy</code></label>
                <input type="checkbox" id="randomize-enable-sy" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-mx">Generate <code>mx</code></label>
                <input type="checkbox" id="randomize-enable-mx" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-my">Generate <code>my</code></label>
                <input type="checkbox" id="randomize-enable-my" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-kx">Generate <code>kx</code></label>
                <input type="checkbox" id="randomize-enable-kx" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="randomize-enable-ky">Generate <code>ky</code></label>
                <input type="checkbox" id="randomize-enable-ky" checked="true">
              </ui-element>
            </li>
            <li>
              <ui-element>
                <label for="mutate-enable-ops">Mutate ops</label>
                <input type="checkbox" id="mutate-enable-ops" checked="true">
              </ui-element>
            </li>

            <li>
              <ui-element>
                <label for="mutate-enable-values">Mutate values</label>
                <input type="checkbox" id="mutate-enable-values" checked="true">
              </ui-element>
            </li>
          </ul>
        </details>
      </f-col>
      <f-col class="gap-1 canvas-column">
        <canvas id="canvas" height="1024" width="1024" tabindex="1"></canvas>
        <f-col class="gap-2">
          <f-row>
            <f-col>
              <div id="coord-display"></div>
              <div id="recording-indicator" class="hidden">Recording...</div>
            </f-col>
            <f-sp></f-sp>
            <img id="image-display" class="small-square" />
            <video autoplay width="128" id="video-display" loop poster="black.png" class="hidden small-square"></video>
        </f-col>
        <button id="screenshot-btn" class="hidden">Take Screenshot</button>
        <f-col class="gap-1 align-right">
          <ui-element>
            <label>Manual Recording: </label>
            <input type="number" placeholder="start t" id="video-encoding-start-frame" class="small-text-input">
            -
            <input type="number" placeholder="end t" id="video-encoding-end-frame" class="small-text-input">
          </ui-element>
          <button id="video-encoding-manual-record-btn">Record GIF</button>
        </f-col>
        </f-row>
      </f-col>
      <code id="error-msg"></code>
    </main>
    <div>
      <h2>Quick Start Guide</h2>
      <strong>!!! Important !!! BROKEN_FIELD shaders often results in rapidly flashing or flickering output!</strong>
      <p>BROKEN_FIELD is a tiny shader toy inspired by <a href="http://canonical.org/~kragen/bytebeat/">Bytebeat
          music</a>. BROKEN_FIELD can be used to create or procedurally generate tiny, interactive art programs. The
        textbox above defines a simple per-pixel shader. The output of the shader is then displayed on the canvas on the
        right. For each pixel, the program is expected to output an integer. The value of the integer, modulo 256,
        determines the brightness of the corresponding outputted pixel.</p>
      <p>As an example, suppose we have the following program: <code>sx * sy</code>. This program is run for each
        pixel of the output canvas. Hence, for the pixel at coordinates <code>(50, 30)</code>, the output of the program
        is <code>50 * 30 = 1500 mod 256 = 220 = 0xDC</code>. By default, this gives that particular pixel the hex color
        <code>0x00DC00</code>. This process is repeated for every pixel, which forms the final output image.
      </p>
      <p>Note that these programs are just fragments of <a
           href="https://en.wikipedia.org/wiki/OpenGL_Shading_Language">GLSL</a> inserted into a GLSL shader. Hence, all
        of the GLSL functions are available. See below for some technical details.</p>
      <h2>Controls</h2>
      <ul>
        <li>Restart - Reset the current frame time to the start value.</li>
        <li>Randomize - Generate a random shader.</li>
        <li>Mutate - Mutate the current shader.</li>
        <li>Time Scale - Set the values the frame time will start and end at. Leave the ending time blank for no looping
        </li>
        <li>Color - Sets the color of the shader. Defaults to green (<code>#00FF00</code>).</li>
        <li>Wrap Value - Sets the range to which the shader ouput will be constrained to. For example, if the shader
          outputs the value <code>735</code> and the wrap value is <code>32</code>, then the value is constrained to
          <code>rem_euclid(735, 32) = 31</code>. Defaults to <code>256</code>.
        </li>
        <li>Canvas Size - Sets the <em>internal</em> canvas resolution. The canvas itself will not change size, but the
          internal resolution will. Note that screenshots and videos will have a resolution equal to whatever this value
          is. (So, for example, if the canvas size is <code>256 x 512</code>, then all screenshots and videos will have
          an output resolution of <code>256 x 512</code>). Very large canvas sizes may not work properly or consume a
          large amount of memory. Defaults to <code>1024 x 1024</code>.
        </li>
        <li>Randomization History - Contains a list of all the prior randomization/mutation attempts.</li>
      </ul>
      </p>
      <h2>Image & Video Export</h2>
      <p>You can take a screenshot of the current canvas by using the "Take Screenshot" button or clicking on the
        canvas. This will take a picture of the canvas as a PNG and is shown in the small square below the canvas.</p>
      <p>You can also record a video of the current canvas by pressing "R". Press "R" again to stop the recording.
        Holding "Shift" while starting the recording will reset the current frame time to zero (or whatever the starting
        frame time is set to), allowing you to capture the start of the shader. This will export a WebM.</p>
      <p>Finally, you can also record a GIF using the "Record GIF" button. The "Manual Recording" input textboxes will
        determine which values of <code>t</code> will be shown in the exported GIF. <strong>Important!</strong> Large
        resolutions and long GIFs will take a long time to render and will have a large file size. You may want to use a
        site like <a href="https://ezgif.com/optimize">ezgif</a> to reduce the file size of the GIF.
      </p>

      <h2>Complete list of variables</h2>
      <ul>
        <li><code>t</code> - <b>t</b>ime - Equals the current frame. The rate at which this value increases (or
          decreases) can be controlled with the "Time Scale" slider.</li>
        <li><code>sx</code> - <b>s</b>creen <b>x</b>-coordinate - Equals the x-coordinate of the pixel. Note that the
          x-coordinate increases in the rightwards direction.</li>
        <li><code>sy</code> - <b>s</b>creen <b>y</b>-coordinate - Equals the y-coordinate of the pixel. Note that the
          y-coordinate increases in the upwards direction.</li>
        <li><code>mx</code> - <b>m</b>ouse <b>x</b>-coordinate - Equals the x-coordinate of the mouse. Note that the
          x-coordinate increases in the rightwards direction.</li>
        <li><code>my</code> - <b>m</b>ouse <b>y</b>-coordinate - Equals the y-coordinate of the mouse. Note that the
          y-coordinate increases in the upwards direction.</li>
        <li><code>kx</code> - <b>k</b>eyboard <b>x</b>-coordinate - Increased by one by pressing right and decreased by
          one by pressing left.</li>
        <li><code>ky</code> - <b>k</b>eyboard <b>y</b>-coordinate - Increased by one by pressing up and decreased by one
          by pressing down.</li>

      </ul>
      <p>You can append <code>_f</code> to any of these variables to get a float-valued verison of the variable. For
        example, <code>t_f</code> is equal to the current frame value, but as a float.</p>
      <h2>Technical Details</h2>
      <p>All of this stuff is just a GLSL fragment shader under the hood. Specifically, it's this shader:</p>
      <pre>#version 300 es
precision mediump float;

uniform float wrap_value;
uniform int t, mx, my, kx, ky;
uniform float t_f, mx_f, my_f, kx_f, ky_f;

uniform vec3 color;
out vec4 fragColor;

void main() {
  float sx_f = gl_FragCoord.x - 0.5;
  float sy_f = gl_FragCoord.y - 0.5;
  int sx = int(sx_f);
  int sy = int(sy_f);
  int value = ${bytebeat};
  value = value % int(wrap_value);
  value = value < 0 ? value + int(wrap_value) : value;
  float value_out = float(value) / wrap_value;
  fragColor = vec4(value_out * color, 1.0);
}</pre>
      <p>In the shader above, <code>${bytebeat}</code> is substituted with whatever you type into the textarea.</p>
      <p>(The vertext shader is extremely boring. it is literally this four-line shader:
      <pre>#version 300 es
in vec4 aVertexPosition;

void main() {
    gl_Position = aVertexPosition;
}</pre>
      </p>
    </div>
</body>

</html>